<!doctype HTML>
<html>

<head>
    <title>Kimmel Club Fest WIP</title>
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1, maximum-scale=1">
    <link rel="icon" href="/favicon.ico" />
    <!-- Include A-Frame and extras -->
    <script src="https://aframe.io/releases/0.8.2/aframe.min.js"></script>
    <script src="https://unpkg.com/aframe-orbit-controls@1.0.0/dist/aframe-orbit-controls.min.js"></script>
    <script src="https://unpkg.com/aframe-supercraft-loader@1.1.3/dist/aframe-supercraft-loader.js"></script>
    <!-- This script is only for different textures on multi-sided primitives, won't be needed with a model -->
    <script src="https://cdn.rawgit.com/elbobo/aframe-multisrc-component/b6d23310/dist/0.3/aframe-multisrc-component.js"></script>
    <!-- Include ar.js for A-Frame -->
    <!-- <script src="/static/js/aframe-ar.js"></script> -->

    <script>
        // Adds an event listener for mousedown events, calling mouseCheck() if so.
        AFRAME.registerComponent('a-click', {
            schema: { // Attributes
                text: {default: 'Something was clicked!'},
                mousedown: {type: 'boolean', default: false},
                mousemoved: {type: 'boolean', default: false}
            },

            init: function () {
                var el = this.el;
                el.addEventListener('mousedown', (evt) => {
                    evt.preventDefault()
                    // Using the mousedown schema, register only the first click to prevent multitouch issues
                    if (!el.getAttribute('a-click').mousedown) {
                        el.setAttribute('a-click', {mousedown: true});
                        el.setAttribute('opacity', 0.5);
                        // Alternative to all this, would it make more sense to only look
                        // for clicks as quick successions?
                        mouseCheck(evt);
                    }
                });
            }
        });

        // Add temporary listeners until a mouseup event occurs
        function mouseCheck(e) {
            var el = e.target;
            console.log('mousedown on: ' + el.id);
            el.addEventListener('mouseleave', leaveListener);
            el.addEventListener('mouseenter', enterListener);
            el.addEventListener('mouseup', upListener);
            // ESSENTIAL CLOSURE TIP: Event callback functions are ALWAYS passed an event parameter!!!
        }

        function leaveListener() {
            //console.log('mouse left');
            el.setAttribute('a-click', {mousemoved: true});
            this.setAttribute('opacity', 0);
        }
        function enterListener() {
            //console.log('mouse entered');
            if (this.getAttribute('a-click').mousemoved) {
                this.setAttribute('a-click', {mousemoved: false});
                this.setAttribute('opacity', 0.5);
            }
        }
        function upListener() {
            var el = event.target;
            console.log('Did mouse move? ' + el.getAttribute('a-click').mousemoved);
            if (!this.getAttribute('a-click').mousemoved) {
                // Check for active highlighting
                //if (el.getAttribute('highlight-status').active) {
                    // Swap display for this floor
                //alert('Load ' + el.id + ' :)');
                //}
                // else {
                //     // emit highlight-status
                //     el.setAttribute('highlight-status', {event: 'highlight-update', active: true});
                //     el.emit('highlight-update');
                // }
                el.setAttribute('opacity', 0);
                console.log(el.id + ' clicked!');
            }
            el.setAttribute('a-click', {mousemoved: false});
            el.setAttribute('a-click', {mousedown: false});
            el.removeEventListener('mouseleave', leaveListener);
            el.removeEventListener('mouseenter', enterListener);
            el.removeEventListener('mouseup', upListener);
        }

        // Maintains a highlight status and adds a status listener.
        // AFRAME.registerComponent('highlight-status', {
        //     schema: {
        //         event: {type: 'string', default: ''},
        //         active: {type: 'boolean', default: false}
        //     },
        //     init: function () {
        //         var el = this.el;
        //         el.addEventListener('highlight-update', (evt) => {
        //             console.log(this);
        //             // console.log(el);
        //             if (el.id != this.el.id) {
        //                 el.setAttribute('opacity', 0);
        //             }
        //             else {
        //                 // Add highlighting to this element
        //                 el.setAttribute('opacity', 0.5);
        //             }
        //         });
        //     }
        // });

    </script>
</head>

<body style='margin: 0px; overflow: hidden;'>
    <a-scene id="scene">
        <!-- Use this Asset Management System to ensure assets are cached and loaded before rendering -->
        <a-assets>
            <img id="kimmel-right" src="/image/kimmel-side-square.jpg" />
            <img id="kimmel-left" src="/image/kimmel-side-square.jpg" />
            <img id="kimmel-top" src="/image/nyu.jpg" />
            <img id="kimmel-bottom" src="/image/nyu.jpg" />
            <img id="kimmel-front" src="/image/kimmel-front-square.jpg" />
            <img id="kimmel-back" src="/image/kimmel-front-square.jpg" />
            <img id="sky" src="/image/sky.jpg">
        </a-assets>

        <a-sky id="skybox"
            rotation="0 130 0"
            src="#sky">
        </a-sky>

        <!-- Position = "(left<->right) (down<->up) (far<->near)" -->
        <!-- Rotation = "(x, y, z)" -->
        <a-box id="kimmel-model"
            position="0 -0.3 -3"
            rotation="0 15 0"
            height="1"
            width="0.743"
            depth="1.286"
            multisrc="srcs: #kimmel-right,#kimmel-left,#kimmel-top,#kimmel-bottom,#kimmel-front,#kimmel-back"
            shadow>
        </a-box>

        <a-box id="kimmel-floor-0"
            clickable
            a-click="text: 'kimmel fl. 0 clicked'"
            highlight-status="active: false"
            position="0 -0.56 -3"
            rotation="0 15 0"
            height="0.50"
            width="0.75"
            depth="1.3"
            color="orange"
            opacity="0"
            shadow>
        </a-box>

        <a-box id="kimmel-floor-1"
            clickable
            a-click="text: 'kimmel fl. 0 clicked'"
            highlight-status="active: false"
            position="0 -0.05 -3"
            rotation="0 15 0"
            height="0.52"
            width="0.75"
            depth="1.3"
            color="orange"
            opacity="0"
            shadow>
        </a-box>

        <a-circle
            position="0 -0.8 -3"
            rotation="-90 0 0"
            radius="1.3"
            material="color: #22B850"
            shadow>
        </a-circle>

        <!-- <a-light type="ambient"></a-light>
        <a-light type="directional" intensity="1.6" position="-5 4 -1.2"></a-light> -->

        <a-entity
            camera
            orbit-controls="target: 0 -0.8 -3; minDistance: 1.3; maxDistance: 8; rotateSpeed: 0.04; minPolarAngle: 17; maxPolarAngle: 83; initialPosition: 0 0 0">
        </a-entity>
        <a-entity cursor="rayOrigin: mouse;" raycaster="objects: [clickable];"></a-entity>
    </a-scene>
</body>

</html>
