<!doctype HTML>
<html>

<head>
    <meta charset="utf-8" />
    <link rel="icon" href="/favicon.ico" />
    <title>Kimmel Club Fest WIP</title>
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1, minimum-scale=1, maximum-scale=1">
    <style>
    html {
        touch-action: manipulation;
    }
    </style>
    <!-- Include A-Frame Master and extras -->
    <script src="https://cdn.jsdelivr.net/gh/aframevr/aframe@76a666e65127337159d7447b304bf114acc35f25/dist/aframe-master.min.js"></script>
    <script src="https://unpkg.com/aframe-orbit-controls@1.2.0/dist/aframe-orbit-controls.min.js"></script>
    <script src="https://unpkg.com/aframe-look-at-component@0.7.0/dist/aframe-look-at-component.min.js"></script>
    <script src="https://unpkg.com/aframe-event-set-component@4.1.2/dist/aframe-event-set-component.min.js"></script>
    <!-- This script is only for different textures on multi-sided primitives, won't be needed with a model -->
    <script src="https://cdn.rawgit.com/elbobo/aframe-multisrc-component/b6d23310/dist/0.3/aframe-multisrc-component.js"></script>
    <!-- Include ar.js for A-Frame -->
    <!-- <script src="/static/js/aframe-ar.js"></script> -->

    <script>
        // Hide A-Frame's injected VR-mode button.
        window.onload = function() {
            var elms = document.getElementsByClassName('a-enter-vr');
            elms[0].style.visibility = 'hidden';
        };

        // A solution for using the look-at and orbit-controls A-Frame components in tandem.
        // Open source contribution potential to make this less of a hack.
        // Detail from this issue with the solution: https://github.com/supermedium/superframe/issues/200
        AFRAME.registerComponent('camera-facer', {
            tick: function() {
                let cameraPosition = camera.getObject3D('camera').position;
                camerarig.setAttribute('position', cameraPosition);
            },
            // Testing implementing touch event response
            init: function() {
            //    this.el.sceneEl.addEventListener('touchstart', respond);
            }
        });

        // Adds an event listener for mouse events, using mouseCheck() to follow up from mousedowns.
        AFRAME.registerComponent('a-click', {
            schema: { // Attributes
                mouseDown: {type: 'boolean', default: false},
                mouseMoved: {type: 'boolean', default: false},
                opacityStart: {type: 'float', default: 0},
                opacityActive: {type: 'float', default: 0.5}
            },
            init: function () {
                var el = this.el;
                el.addEventListener('mousedown', (evt) => {
                    // Using the mouseDown schema, register only the first click to prevent multitouch issues
                    if (!el.getAttribute('a-click').mouseDown) {
                        el.setAttribute('opacity', el.getAttribute('a-click').opacityActive);
                        el.setAttribute('a-click', {mouseDown: true});
                        mouseCheck(evt);
                    }
                });
            }
        });

        // Temporarily add listeners until a mouseup event occurs, upListener removes them.
        function mouseCheck(e) {
            var el = e.target;
            //console.log('mousedown on: ' + el.id);
            el.addEventListener('mouseup', upListener);
            el.addEventListener('mouseleave', leaveListener);
            el.addEventListener('mouseenter', enterListener);
            // ESSENTIAL CLOSURE TIP: Event callback functions are ALWAYS passed to the event as a parameter!! Much easier to remove listeners without attributes.
        }

        function leaveListener() {
            //console.log('mouse left');
            this.setAttribute('a-click', {mouseMoved: true});
            this.setAttribute('opacity', this.getAttribute('a-click').opacityStart);
        }
        function enterListener() {
            //console.log('mouse entered');
            if (this.getAttribute('a-click').mouseMoved) {
                this.setAttribute('a-click', {mouseMoved: false});
                this.setAttribute('opacity', this.getAttribute('a-click').opacityActive);
            }
        }
        function upListener() {
            var el = event.target;
            el.setAttribute('a-click', {mouseMoved: false});
            el.setAttribute('a-click', {mouseDown: false});
            el.removeEventListener('mouseleave', leaveListener);
            el.removeEventListener('mouseenter', enterListener);
            if (!el.getAttribute('a-click').mouseMoved) {
                el.setAttribute('opacity', el.getAttribute('a-click').opacityStart);
                console.log(el.id + ' clicked');
            }
            el.removeEventListener('mouseup', upListener);
        }
    </script>
</head>

<body style='margin: 0px; overflow: hidden;'>
    <a-scene camera-facer id="scene" cursor="rayOrigin: mouse; fuse: false" raycaster="objects: .clickable">
        <!-- Use this Asset Management System to ensure assets are cached and loaded before rendering -->
        <a-assets>
            <img id="kimmel-right" src="/image/kimmel-side-square.jpg" />
            <img id="kimmel-left" src="/image/kimmel-side-square.jpg" />
            <img id="kimmel-top" src="/image/nyu.jpg" />
            <img id="kimmel-bottom" src="/image/nyu.jpg" />
            <img id="kimmel-front" src="/image/kimmel-front-square.jpg" />
            <img id="kimmel-back" src="/image/kimmel-front-square.jpg" />
            <img id="sky" src="/image/sky.jpg">
        </a-assets>

        <a-sky id="skybox"
            rotation="0 130 0"
            src="#sky">
        </a-sky>

        <!-- Position = "(left<->right) (down<->up) (far<->near)" -->
        <!-- Rotation = "(x, y, z)" -->
        <a-box id="kimmel-model"
            position="0 -0.3 -3"
            rotation="0 15 0"
            height="1"
            width="0.743"
            depth="1.286"
            multisrc="srcs: #kimmel-right,#kimmel-left,#kimmel-top,#kimmel-bottom,#kimmel-front,#kimmel-back"
            shadow>
        </a-box>

        <a-box id="kimmel-floor-0" class="clickable"
            event-set__down="_event: mousedown; opacity: 0.5"
            event-set__up="_event: mouseup; opacity: 0"
            position="0 -0.56 -3"
            rotation="0 15 0"
            height="0.50"
            width="0.75"
            depth="1.3"
            color="orange"
            opacity="0"
            shadow>
        </a-box>

        <a-box id="kimmel-floor-1" class="clickable"
            a-click="opacityStart: 0; opacityActive: 0.5"
            position="0 -0.05 -3"
            rotation="0 15 0"
            height="0.52"
            width="0.75"
            depth="1.3"
            color="orange"
            opacity="0"
            shadow>
        </a-box>

        <a-circle
            position="0 -0.8 -3"
            rotation="-90 0 0"
            radius="1.3"
            material="color: #22B850"
            shadow>
        </a-circle>

        <a-box class="clickable"
            a-click="opacityStart: 1; opacityActive: 0.5"
            look-at="#camerarig"
            position="0.5 0.5 -3"
            scale="0.2 0.2 0.2"
            color="orange">
        </a-box>

        <!-- <a-light type="ambient"></a-light>
        <a-light type="directional" intensity="1.6" position="-5 4 -1.2"></a-light> -->
        <a-box id="camerarig" position="0 0 0" scale="1 1 1" opacity="0"></a-box>
        <a-entity id="camera"
            camera
            orbit-controls="target: 0 -0.8 -3; minDistance: 1.3; maxDistance: 8; rotateSpeed: 0.04; minPolarAngle: 17; maxPolarAngle: 83; initialPosition: 0 0 0">
        </a-entity>
    </a-scene>
</body>

</html>
